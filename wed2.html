<!DOCTYPE html>
<html lang="en-gb" dir="ltr">

    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Changchang Liu's personal page. Changchang Liu is a Landscape designer and visual designer. She is also the creator of Catrait."/>
        <meta name="keywords" content="Landscape Architecture, Changchang Liu, Changchang, Landscape Designer, Visual Designer">
        <title>Changchang Liu</title>
        <link rel="shortcut icon" href="images/favicon.ico" type="image/x-icon">
        <link rel="apple-touch-icon-precomposed" href="images/apple-touch-icon.png">
        <link rel="stylesheet" href="css/uikit.docs.min.css">
        <link rel= "stylesheet" href="css/components/upload.min.css">
        <link ref="stylesheet" href="css/components/upload.gradient.min.css">
        <script src="js/jquery.js"></script>
        <script src="js/uikit.min.js"></script>
        <script src="js/components/upload.min.js"></script>
        <script>
            var name = '';
            
            function submitName() {
                var text = $('#name').val();
                if (text === '') {
                    alert('Name cannot be empty');
                    return;
                }
            }
            
            function setCookie(cname, cvalue) {
                var d = new Date();
                d.setTime(d.getTime() + (30*24*60*60*1000));
                var expires = "expires="+ d.toUTCString();
                document.cookie = cname + "=" + cvalue + "; " + expires;
            }
            
            function getCookie(cname) {
                var name = cname + "=";
                var ca = document.cookie.split(';');
                for(var i = 0; i <ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0)==' ') {
                        c = c.substring(1);
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length,c.length);
                    }
                }
                return "";
            }
            
            window.onload = function pageLoaded() {
                checkName();
            }
            
            $( window ).unload(function() {
                // Uncomment this for debugging
                //setCookie("name", name);
            });
            
            
            function checkName() {
                name = getCookie("name");
                if (name === '') {
                    console.log('Presenting model');
                    UIkit.modal.prompt("Please tell us who you are:", '', function(newvalue){
                        console.log("In name prompt");
                        if (newvalue === '') {
                            name = "GuestSecret";
                        } else {
                            name = newvalue;
                        }
                        $('#name-label').text("Welcome, " + name);
                        setCookie("name", name);
                    });
                } else {
                    $('#name-label').text("Welcome, " + name);
                }
            }
            
            var MAX_HEIGHT = 500;
            function render(src){
                var image = new Image();
                image.onload = function(){
                    var canvas = document.getElementById("myCanvas");
                    if(image.height > MAX_HEIGHT) {
                        image.width *= MAX_HEIGHT / image.height;
                        image.height = MAX_HEIGHT;
                    }
                    var ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    canvas.width = image.width;
                    canvas.height = image.height;
                    ctx.drawImage(image, 0, 0, image.width, image.height);
                    uploadImage();
                };
                image.src = src;
            }
            
            function loadImage(src){
                //	Prevent any non-image file type from being read.
                if(!src.type.match(/image.*/)){
                    console.log("The dropped file is not an image: ", src.type);
                    return;
                }

                //	Create our FileReader and run the results through the render function.
                var reader = new FileReader();
                reader.onload = function(e){
                    render(e.target.result);
                };
                reader.readAsDataURL(src);
            }
            
            function fileSelected(event) {
                loadImage(event.target.files[0]);
            }
            
            function uploadImage() {
                $.post('/app/Welcome/upload',
                       {"image":$("#myCanvas").get(0).toDataURL("image/png")},
                        function (data){
                            console.log("Upload Completed: " + data);
                            var o;
                            try {
                                o = JSON.parse(data);
                            } catch(e) {
                                console.log("Result is not JSON");
                                return;
                            }
                            $('#upload-result').text('Uploaded image ' + o["index"]);
                        }
                       );
            }
        </script>
    
    </head>
    <body>
        <div>
            <p id="name-label"></p>
        </div>
        
        
        <div id="upload-drop" class="uk-placeholder uk-text-center">
            <i class="uk-icon-cloud-upload uk-icon-medium uk-text-muted uk-margin-small-right"></i> Attach binaries by dropping them here or <a class="uk-form-file">selecting one<input id="upload-select" type="file" onchange="javascript:fileSelected(event)"></a>.
        </div>
        
        <canvas id="myCanvas" width="200" height="100"></canvas>

        <div id="progressbar" class="uk-progress uk-hidden">
            <div class="uk-progress-bar" style="width: 0%;">...</div>
        </div>
        
        <div>
            <p id="upload-result"></p>
        </div>
    </body>
</html>
